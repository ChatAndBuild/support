name: Restrict Issue Comments

on:
  issue_comment:
    types: [created]

jobs:
  restrict-comments:
    runs-on: ubuntu-latest
    steps:
      - name: Check and restrict comments
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const { issue, comment, sender } = context.payload;
            const orgName = 'ChatAndBuild';
            
            // Skip if no comment (shouldn't happen with this trigger)
            if (!comment) return;
            
            // Allow organization members
            try {
              await github.rest.orgs.checkMembershipForUser({
                org: orgName,
                username: sender.login
              });
              console.log(`‚úÖ Allowing comment from organization member: ${sender.login}`);
              return;
            } catch (error) {
              console.log(`‚ùå ${sender.login} is not an organization member`);
            }
            
            // Allow issue creator
            if (issue.user.login === sender.login) {
              console.log(`‚úÖ Allowing comment from issue creator: ${sender.login}`);
              return;
            }
            
            // Restrict unauthorized user
            console.log(`üö´ Restricting comment from unauthorized user: ${sender.login}`);
            
            try {
              // Delete the comment
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id
              });
              console.log(`‚úÖ Deleted comment from ${sender.login}`);
              
              // Lock the issue
              await github.rest.issues.lock({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });
              console.log(`‚úÖ Locked issue #${issue.number}`);
              
              // Add warning comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚ö†Ô∏è **Comment Restricted**\n\n@${sender.login}, only organization members (@${orgName}) and the issue creator (@${issue.user.login}) can comment on this issue. Your comment has been removed and the issue has been locked.`
              });
              
            } catch (error) {
              console.error('Error restricting comment:', error);
            }
