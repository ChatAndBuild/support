name: Restrict Issue Comments

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write

jobs:
  moderate-comments:
    runs-on: ubuntu-latest
    steps:
      - name: Check permissions and moderate
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get issue and comment details
          ISSUE_NUMBER=${{ github.event.issue.number }}
          COMMENT_ID=${{ github.event.comment.id }}
          COMMENT_USER="${{ github.event.comment.user.login }}"
          ISSUE_CREATOR="${{ github.event.issue.user.login }}"
          ORG_NAME_1="ChatAndBuild"
          ORG_NAME_2="Pivotal-Research"
          REPO="${{ github.repository }}"
          
          echo "Processing comment by $COMMENT_USER on issue #$ISSUE_NUMBER"
          
          # Check if commenter is issue creator
          if [ "$COMMENT_USER" = "$ISSUE_CREATOR" ]; then
            echo "âœ… Allowing comment from issue creator: $COMMENT_USER"
            exit 0
          fi
          
          # Check if commenter is organization member
          if gh api "orgs/$ORG_NAME_1/members/$COMMENT_USER"; then
            echo "âœ… Allowing comment from org member: $COMMENT_USER"
            exit 0
          fi

          # Check if commenter is organization member
          if gh api "orgs/$ORG_NAME_2/members/$COMMENT_USER"; then
            echo "âœ… Allowing comment from org member: $COMMENT_USER"
            exit 0
          fi
          
          echo "ðŸš« Restricting comment from unauthorized user: $COMMENT_USER"
          
          # Delete the unauthorized comment
          gh api -X DELETE "/repos/$REPO/issues/comments/$COMMENT_ID"
          echo "âœ… Deleted comment from $COMMENT_USER"
