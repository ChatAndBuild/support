name: Restrict Issue Comments - Simple

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  simple-restriction:
    runs-on: ubuntu-latest
    steps:
      - name: Restrict non-member comments
        uses: actions/github-script@v6
        with:
          script: |
            const { issue, comment, sender } = context.payload;
            
            // Always allow issue creator
            if (issue.user.login === sender.login) {
              return;
            }
            
            // Try to check org membership - if this fails, assume not a member
            let isOrgMember = false;
            try {
              await github.rest.orgs.checkMembershipForUser({
                org: 'ChatAndBuild',
                username: sender.login
              });
              isOrgMember = true;
            } catch (error) {
              isOrgMember = false;
            }
            
            if (!isOrgMember) {
              // Delete comment and lock issue
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id
              });
              
              await github.rest.issues.lock({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });
              
              // Add explanation
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'ðŸ”’ This issue is now locked. Only organization members and the issue creator may comment.'
              });
            }
